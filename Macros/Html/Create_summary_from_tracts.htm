<!doctype html public "-//w3c//dtd html 4.0 final//en">
<html>
   <head>
      <title>C:\DCData\GitHub\SAS\Macros\Create_summary_from_tracts.sas</title>
   </head>
   <body>
      <pre>
/**************************************************************************
 Macro:    Create_summary_from_tracts
 Library:  Macros
 Project:  NeighborhoodInfo DC
 Author:   P. Tatian
 Created:  07/29/06
 Version:  SAS 8.2
 Environment:  Windows
 
 Description: Create geographic summary data set
 from a tract summary data set for the specified geography.

 Modifications:
  09/26/06  Added LIB= parameter.
  11/21/06  Modify SORTEDBY= option for output data set.
  12/08/06  Changed $GEOLBL to $GEODLBL.
  12/22/10 PAT Added MPRINT= parameter.
  02/24/11 PAT Added declaration for local macro vars.
  07/14/12 PAT Added TRACT_YR= parameter for specifying source tract year.
**************************************************************************/

%macro Create_summary_from_tracts( 
  geo=, 
  lib=,
  data_pre=,
  data_label=,
  count_vars=, 
  prop_vars=,
  calc_vars=,
  calc_vars_labels=,
  tract_yr=,
  register=, 
  creator_process=,
  restrictions=,
  revisions=,
  mprint=n
);

  %local wtfile geosuf geodlbl geofmt tractid;

  %let geo = %upcase( &amp;geo );
  %let register = %upcase( &amp;register );
  
  %if &amp;tract_yr = 2000 %then %do;
    %let tractid = Geo2000;
    %let wtfile = %sysfunc( putc( &amp;geo, $geotw0f. ) );
  %end;
  %else %if &amp;tract_yr = 2010 %then %do;
    %let tractid = Geo2010;
    %let wtfile = %sysfunc( putc( &amp;geo, $geotw1f. ) );
  %end;
  %else %do;
    %err_mput( macro=Create_summary_from_tracts, 
               msg=Must specify source tract year as 2000 or 2010: TRACT_YR=&amp;tract_yr.. )
    %note_mput( macro=Create_summary_from_tracts, msg=Macro exiting. )
    %goto exit_macro;
  %end;
  
  %if %sysfunc( putc( &amp;geo, $geoval. ) ) ~= %then %do;
    %let geosuf = %sysfunc( putc( &amp;geo, $geosuf. ) );
    %let geodlbl = %sysfunc( putc( &amp;geo, $geodlbl. ) );
    %let geofmt = %sysfunc( putc( &amp;geo, $geoafmt. ) );
  %end;
  %else %do;
    %err_mput( macro=Create_summary_from_tracts, 
               msg=Invalid or missing value of GEO= parameter: GEO=&amp;geo.. )
    %note_mput( macro=Create_summary_from_tracts, msg=Macro exiting. )
    %goto exit_macro;
  %end;

  %note_mput( macro=Create_summary_from_tracts, 
              msg=Creating &amp;geo level data from &amp;tract_yr census tracts. )

  %Transform_geo_data(
      dat_ds_name=%if &amp;tract_yr = 2000 %then &amp;lib..&amp;data_pre._tr00;
		%else %if &amp;tract_yr = 2010 %then &amp;lib..&amp;data_pre._tr10;,
      dat_org_geo=&amp;tractid,
      dat_count_vars=&amp;count_vars,
      dat_prop_vars=&amp;prop_vars,
      wgt_ds_name=General.&amp;wtfile,
      wgt_org_geo=&amp;tractid,
      wgt_new_geo=&amp;geo,
      wgt_new_geo_fmt=&amp;geofmt,
      wgt_id_vars=,
      wgt_count_var=popwt,
      wgt_prop_var=popwt_prop,
      out_ds_name=&amp;lib..&amp;data_pre.&amp;geosuf,
      out_ds_label=%quote(&amp;data_label, &amp;geodlbl),
      calc_vars=&amp;calc_vars,
      calc_vars_labels=&amp;calc_vars_labels,
      keep_nonmatch=N,
      show_warnings=10,
      print_diag=Y,
      full_diag=N,
      mprint=&amp;mprint
    )
  
  proc datasets library=&amp;lib memtype=(data) nolist;
    modify &amp;data_pre.&amp;geosuf (sortedby=&amp;geo);
  quit;

  %File_info( data=&amp;lib..&amp;data_pre.&amp;geosuf, printobs=0 )
  
  %** Register metadata **;
  
  %if &amp;register = Y %then %do;
    %Dc_update_meta_file(
      ds_lib=&amp;lib,
      ds_name=&amp;data_pre.&amp;geosuf,
      creator_process=&amp;creator_process,
      restrictions=&amp;restrictions,
      revisions=%quote(&amp;revisions)
    )
  %end;
  
  %exit_macro:

%mend Create_summary_from_tracts;



      </pre>
   </body>
</html>
